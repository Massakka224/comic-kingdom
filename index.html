<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comic Kingdom ‚Äì Version 16.0</title>
<style>
  body{font-family:Arial;background:#f2f2f2;margin:0;padding-top:90px}
  nav{position:fixed;top:0;left:0;right:0;background:#fff;padding:10px;display:flex;gap:5px;z-index:100}
  nav button{flex:1;padding:10px;font-size:13px}
  .section{display:none;padding:15px}
  .section.active{display:block}
  .box{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px}
  .item{border:1px solid #ccc;padding:10px;margin:5px 0;cursor:pointer}
  .empty{color:#888;font-style:italic}
  .skill{border:1px solid #ccc;padding:10px;margin:5px 0;position:relative}
  .skill button{position:absolute;right:10px;top:10px}
  .skill.locked{opacity:0.5}
  .skill button:disabled{opacity:0.4}
  .equipSlot{border:1px dashed #999;padding:10px;margin:5px 0;}
  .equipSlot b{display:block;}
  .tooltip{
    position:relative;
    display:inline-block;
    border-bottom:1px dotted #000;
  }
  .tooltip .tiptext{
    visibility:hidden;
    width:220px;
    background:#333;
    color:#fff;
    text-align:left;
    border-radius:6px;
    padding:8px;
    position:absolute;
    z-index:10;
    bottom:125%;
    left:50%;
    transform:translateX(-50%);
    opacity:0;
    transition:opacity 0.3s;
    font-size:12px;
  }
  .tooltip:hover .tiptext{
    visibility:visible;
    opacity:1;
  }
</style>
</head>

<body>

<!-- CHARACTER SELECTION -->
<div id="charSelect" class="section active">
  <div class="box">
    <h2>Charakter ausw√§hlen</h2>
    <div id="charList"></div>

    <h3>Neuen Charakter erstellen</h3>
    <input id="newName" placeholder="Name" />
    <select id="newClass">
      <option value="Krieger">Krieger</option>
      <option value="Magier">Magier</option>
      <option value="Kundschafter">Kundschafter</option>
      <option value="Nekromant">Nekromant</option>
    </select>
    <button onclick="createCharacter()">Erstellen</button>
  </div>
</div>

<!-- GAME UI -->
<nav id="gameNav" style="display:none;">
  <button onclick="show('status')">Status</button>
  <button onclick="show('skills')">Skills</button>
  <button onclick="show('quests')">Quest</button>
  <button onclick="show('inventar')">Inventar</button>
  <button onclick="show('stadt')">Stadt</button>
  <button onclick="show('farm')">Farm</button>
  <button onclick="logout()">Logout</button>
</nav>

<!-- STATUS -->
<div id="status" class="section">
  <div class="box">
    <h2>Status</h2>
    <p>Klasse: <b id="uiClass"></b></p>
    <p>Level: <b id="uiLevel"></b></p>
    <p>XP: <b id="uiXP"></b></p>
    <p>HP: <b id="uiHP"></b></p>
    <p>üü° Gold: <b id="uiGold"></b></p>
    <p>üç´ Schokolade: <b id="uiChocolate"></b></p>
    <p>Angriff: <b id="uiAtk"></b></p>
    <p>Verteidigung: <b id="uiDef"></b></p>
    <p>HP-Regeneration: <b id="uiRegen"></b>/5 Minuten</p>
  </div>

  <div class="box">
    <h3>Ausr√ºstung</h3>
    <div id="equipSlots"></div>
  </div>
</div>

<!-- SKILLS -->
<div id="skills" class="section">
  <div class="box">
    <h2>üå≥ Skillb√§ume</h2>
    <p>Skillpunkte: <b id="uiSkillPoints"></b></p>
    <div id="skillBox"></div>
  </div>
</div>

<!-- QUESTS -->
<div id="quests" class="section">
  <div class="box">
    <h2>Quests</h2>
    <div id="questList"></div>
    <button onclick="acceptQuest()">Quest annehmen</button>
    <button onclick="finishQuest()">Quest abschlie√üen</button>
    <p id="questLog"></p>
  </div>
</div>

<!-- INVENTAR -->
<div id="inventar" class="section">
  <div class="box">
    <h2>Inventar</h2>
    <button onclick="sortInventory()">Sortieren (Qualit√§t)</button>
    <div id="inventoryBox"></div>
  </div>
</div>

<!-- STADT -->
<div id="stadt" class="section">
  <div class="box">
    <h2>Stadt</h2>
    <button onclick="openBuilding('taverne')">üè∞ Taverne</button>
    <button onclick="openBuilding('schmiede')">üõ†Ô∏è Schmiede</button>
    <button onclick="openBuilding('arena')">‚öîÔ∏è Arena</button>
    <button onclick="openBuilding('shop')">üõí Markt</button>
    <button onclick="openBuilding('alchemist')">üß™ Alchemist</button>
  </div>
  <div id="buildingBox"></div>
</div>

<!-- FARM -->
<div id="farm" class="section">
  <div class="box">
    <h2>üåæ Farm</h2>
    <p>Holz: <b id="uiWood"></b> | Stein: <b id="uiStone"></b> | Nahrung: <b id="uiFood"></b></p>
    <button onclick="collectResources()">Ressourcen sammeln</button>
    <button onclick="buildFarm()">Farm bauen (10 Holz + 10 Stein)</button>
    <button onclick="upgradeFarm()">Farm upgraden (20 Holz + 20 Stein)</button>
    <p id="farmLog"></p>
    <p>Farmstatus: <b id="uiFarmStatus"></b></p>
  </div>
</div>

<script>
/* ================= SAVE ================= */
const SAVE_VERSION = 1;
function loadAll(){
  try { return JSON.parse(localStorage.getItem("ck_chars")) || []; }
  catch { return []; }
}
function saveAll(chars){
  localStorage.setItem("ck_chars", JSON.stringify(chars));
}

/* ================= PLAYER ================= */
let chars = loadAll();
let player = null;
let activeId = null;
let autosaveInterval = null;
let regenInterval = null;

/* ================= SKILLDATA ================= */
const skillData={
  Kampf:[
    {id:"kraft",name:"Kraft",max:5,desc:"+2 Angriff",req:null},
    {id:"waffen",name:"Waffenmeister",max:3,desc:"+10% Angriff",req:{kraft:3}}
  ],
  Verteidigung:[
    {id:"zaehigkeit",name:"Z√§higkeit",max:5,desc:"+2 Verteidigung",req:null},
    {id:"eisenhaut",name:"Eisenhaut",max:3,desc:"+10% Verteidigung",req:{zaehigkeit:3}}
  ],
  Magie:[
    {id:"fokus",name:"Fokus",max:3,desc:"+5% XP",req:null},
    {id:"arkane",name:"Arkane Macht",max:5,desc:"+3 Angriff",req:{fokus:2}}
  ],
  Farm:[
    {id:"bauer",name:"Bauernweisheit",max:5,desc:"+10% Ressourcen",req:null},
    {id:"agrar",name:"Agrar-Meister",max:3,desc:"+20% Ressourcen",req:{bauer:3}}
  ],
  Schmiede:[
    {id:"schmied",name:"Schmiedekunst",max:5,desc:"+10% Itemqualit√§t",req:null},
    {id:"meisterschmied",name:"Meisterschmied",max:3,desc:"+20% Itemqualit√§t",req:{schmied:3}}
  ]
};
const allSkills = Object.values(skillData).flat();

/* ================= QUESTS ================= */
const questPool = [
  {id:"q1",name:"Ratten im Keller",lvl:1,xp:40,gold:20,lootChance:0.4,desc:"Besiege die Ratten und finde Loot."},
  {id:"q2",name:"Verlorene M√ºnzen",lvl:2,xp:60,gold:35,lootChance:0.5,desc:"Finde verlorene M√ºnzen in der Stadt."},
  {id:"q3",name:"Banditenlager",lvl:3,xp:90,gold:50,lootChance:0.6,desc:"K√§mpfe gegen Banditen und lootet wertvolle Items."}
];
let activeQuest = null;

/* ================= ITEM SYSTEM ================= */
const slots = ["Waffe","Helm","R√ºstung","Ring"];
const qualities = [
  {n:"Gew√∂hnlich",atk:1,def:1,w:50},
  {n:"Ungew√∂hnlich",atk:2,def:2,w:25},
  {n:"Selten",atk:3,def:3,w:15},
  {n:"Episch",atk:5,def:5,w:7},
  {n:"Legend√§r",atk:8,def:8,w:3}
];

const itemPools = {
  Waffe:["Schwert","Axt","Stab","Dolch","Seelensichel"],
  Helm:["Helm","Kapuzenhelm","Knochenkrone"],
  R√ºstung:["Plattenr√ºstung","Magierrobe","Lederr√ºstung"],
  Ring:["Ring der Kraft","Ring der Abwehr"]
};

function weightedQuality(){
  const pool=[];
  qualities.forEach(q=>{
    for(let i=0;i<q.w;i++) pool.push(q);
  });
  return pool[Math.floor(Math.random()*pool.length)];
}

function generateItem(){
  const q=weightedQuality();
  const slot=slots[Math.floor(Math.random()*slots.length)];
  const names=itemPools[slot];
  return {
    id: Date.now().toString() + Math.random(),
    name: names[Math.floor(Math.random()*names.length)],
    quality: q.n,
    atk: q.atk,
    def: q.def,
    slot,
    levelReq: Math.max(1, Math.floor(Math.random()*player.level) + 1)
  };
}

/* ================= STATS ================= */
function calcStats(){
  let atk = 5 + player.level;
  let def = 5 + player.level;

  atk += player.skills.kraft * 2;
  atk += player.skills.arkane * 3;
  def += player.skills.zaehigkeit * 2;

  atk *= 1 + player.skills.waffen * 0.1;
  def *= 1 + player.skills.eisenhaut * 0.1;

  // add equip bonuses
  for(const s of slots){
    const it = player.equip[s];
    if(it){
      atk += it.atk;
      def += it.def;
    }
  }

  // Farm/Schmiede Skills
  const regenBonus = Math.floor(player.skills.bauer * 0.1 + player.skills.agrar * 0.2);
  const xpBonus = player.skills.fokus * 0.05;
  const lootBonus = player.skills.schmied * 0.05 + player.skills.meisterschmied * 0.1;

  return {
    atk: Math.floor(atk),
    def: Math.floor(def),
    regenBonus,
    xpBonus,
    lootBonus
  };
}

/* ================= NAV ================= */
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ================= CHARACTER SYSTEM ================= */
function renderCharList(){
  const list = document.getElementById("charList");
  list.innerHTML = "";
  if(chars.length===0){
    list.innerHTML = "<p class='empty'>Keine Charaktere vorhanden.</p>";
    return;
  }
  chars.forEach(c=>{
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <b>${c.name}</b> (${c.class}) - Level ${c.level}
      <br>
      <button onclick="selectChar('${c.id}')">Ausw√§hlen</button>
      <button onclick="deleteChar('${c.id}')">L√∂schen</button>
    `;
    list.appendChild(d);
  });
}

function createCharacter(){
  const name = document.getElementById("newName").value.trim();
  const cls  = document.getElementById("newClass").value;

  if(name.length<2){
    alert("Name muss mindestens 2 Zeichen haben.");
    return;
  }

  const newChar = {
    id: Date.now().toString(),
    name,
    class: cls,
    level: 1,
    xp: 0,
    xpMax: 100,
    hp: 100,
    hpMax: 100,
    gold: 50,
    chocolate: 0,
    skillPoints: 0,
    skills: {},
    inventory: [],
    equip: {Waffe:null,Helm:null,R√ºstung:null,Ring:null},
    wood: 0,
    stone: 0,
    food: 0,
    farmBuilt: false,
    farmLevel: 0,
    farmTimer: 0,
    lastSave: Date.now()
  };

  allSkills.forEach(s=> newChar.skills[s.id]=0);

  chars.push(newChar);
  saveAll(chars);
  renderCharList();
}

function deleteChar(id){
  if(!confirm("Charakter wirklich l√∂schen?")) return;
  chars = chars.filter(c=>c.id!==id);
  saveAll(chars);
  renderCharList();
}

function selectChar(id){
  player = JSON.parse(JSON.stringify(chars.find(c=>c.id===id)));
  activeId = id;
  document.getElementById("gameNav").style.display = "flex";
  show("status");
  updateUI();
  startAutoSave();
  startRegen();
  renderQuestList();
}

function logout(){
  stopAutoSave();
  stopRegen();
  player = null;
  activeId = null;
  document.getElementById("gameNav").style.display = "none";
  show("charSelect");
}

/* ================= AUTO SAVE ================= */
function startAutoSave(){
  if(autosaveInterval) clearInterval(autosaveInterval);
  autosaveInterval = setInterval(()=>{
    save();
  }, 10000); // alle 10 Sekunden
}
function stopAutoSave(){
  if(autosaveInterval) clearInterval(autosaveInterval);
}

/* ================= HP REGEN ================= */
function startRegen(){
  if(regenInterval) clearInterval(regenInterval);
  regenInterval = setInterval(()=>{
    if(!player) return;
    const stats = calcStats();
    const regen = 1 + stats.regenBonus; // 1 HP + Bonus
    player.hp = Math.min(player.hpMax, player.hp + regen);
    updateUI();
  }, 300000); // alle 5 Minuten
}
function stopRegen(){
  if(regenInterval) clearInterval(regenInterval);
}

/* ================= QUESTS ================= */
function renderQuestList(){
  const q = document.getElementById("questList");
  q.innerHTML = "";
  questPool.forEach(quest => {
    q.innerHTML += `
      <div class="item">
        <b>${quest.name}</b> (Level ${quest.lvl})<br>
        ${quest.desc}<br>
        XP: ${quest.xp} | Gold: ${quest.gold}<br>
        <button onclick="setActiveQuest('${quest.id}')">Annehmen</button>
      </div>
    `;
  });
}

function setActiveQuest(id){
  activeQuest = questPool.find(q=>q.id===id);
  document.getElementById("questLog").innerText = `Aktive Quest: ${activeQuest.name}`;
}

function acceptQuest(){
  if(!activeQuest) {
    alert("W√§hle zuerst eine Quest aus.");
    return;
  }
  document.getElementById("questLog").innerText = `Quest angenommen: ${activeQuest.name}`;
}

function finishQuest(){
  if(!activeQuest){
    alert("Keine Quest aktiv.");
    return;
  }

  if(player.level < activeQuest.lvl){
    alert("Du bist zu niedrig level f√ºr diese Quest.");
    return;
  }

  // XP + Gold + Loot
  const stats = calcStats();
  let xpGain = Math.floor(activeQuest.xp * (1 + stats.xpBonus));
  player.xp += xpGain;
  player.gold += activeQuest.gold;

  let choc = Math.random() < 0.1 ? 1 : 0;
  player.chocolate += choc;

  let loot = "Kein Loot.";
  if(Math.random() < activeQuest.lootChance + stats.lootBonus){
    const it = generateItem();
    player.inventory.push(it);
    loot = `Loot: ${it.name} (${it.quality})`;
  }

  // Level up
  while(player.xp >= player.xpMax){
    player.xp -= player.xpMax;
    player.level++;
    player.skillPoints++;
    player.hpMax += 20;
    player.hp = player.hpMax;
    player.xpMax = Math.floor(player.xpMax * 1.25);
  }

  document.getElementById("questLog").innerHTML =
    `Quest abgeschlossen!<br>+${xpGain} XP<br>+${activeQuest.gold} Gold<br>+${choc} Schokolade<br>${loot}`;

  save();
  updateUI();
}

/* ================= INVENTAR UI ================= */
function updateInventory(){
  const inv = document.getElementById("inventoryBox");
  inv.innerHTML="";
  if(player.inventory.length===0){
    inv.innerHTML="<p class='empty'>Inventar leer</p>";
    return;
  }
  player.inventory.forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `
      <b>${it.name}</b> (${it.quality})<br>
      ${it.slot} | Level ${it.levelReq}<br>
      <button onclick="showItem('${it.id}')">Details</button>
      <button onclick="sellItem('${it.id}')">Verkaufen</button>
    `;
    inv.appendChild(d);
  });
}

function showItem(id){
  const it = player.inventory.find(x=>x.id===id);
  if(!it) return;

  let canEquip = player.level >= it.levelReq;
  let action = canEquip ? "Ausr√ºsten" : "Nicht levelbar";

  let current = player.equip[it.slot];
  let compare = current ? `Aktuell: ${current.name} (+${current.atk}/${current.def})` : "Aktuell: leer";

  if(confirm(
    `Item: ${it.name}\nQualit√§t: ${it.quality}\nSlot: ${it.slot}\nAngriff: ${it.atk}\nVerteidigung: ${it.def}\nLevelanforderung: ${it.levelReq}\n\n${compare}\n\n${canEquip ? "Willst du es ausr√ºsten?" : "Du bist zu niedrig level."}`
  )){
    if(canEquip){
      equipItem(it.id);
    }
  }
}

function sellItem(id){
  const it = player.inventory.find(x=>x.id===id);
  if(!it) return;

  const sellPrice = Math.floor((it.atk + it.def) * 5);
  if(confirm(`Item verkaufen f√ºr ${sellPrice} Gold?`)){
    player.gold += sellPrice;
    player.inventory = player.inventory.filter(x=>x.id!==id);
    updateUI();
    save();
  }
}

function sortInventory(){
  player.inventory.sort((a,b)=>{
    const qa = qualities.findIndex(q=>q.n===a.quality);
    const qb = qualities.findIndex(q=>q.n===b.quality);
    return qb - qa;
  });
  updateInventory();
}

/* ================= EQUIP ================= */
function equipItem(id){
  const it = player.inventory.find(x=>x.id===id);
  if(!it) return;

  if(player.level < it.levelReq){
    alert("Level zu niedrig.");
    return;
  }

  const slot = it.slot;
  const old = player.equip[slot];
  player.equip[slot] = it;

  player.inventory = player.inventory.filter(x=>x.id!==id);

  if(old) player.inventory.push(old);

  save();
  updateUI();
}

/* ================= EQUIP UI ================= */
function renderEquip(){
  const box = document.getElementById("equipSlots");
  box.innerHTML = "";
  for(const s of slots){
    const it = player.equip[s];
    box.innerHTML += `
      <div class="equipSlot">
        <b>${s}</b>
        ${it ? `${it.name} (${it.quality}) +${it.atk}ATK / +${it.def}DEF` : "<span class='empty'>Leer</span>"}
      </div>`;
  }
}

/* ================= BUILDINGS ================= */
function openBuilding(id){
  const box = document.getElementById("buildingBox");
  box.innerHTML="";
  if(id==="taverne"){
    box.innerHTML = `
      <p>üõ°Ô∏è Taverne: Quests & Geschichten</p>
      <p class="empty">(Jetzt mit echten Quests & Loot)</p>
    `;
  }
  if(id==="schmiede"){
    box.innerHTML = `
      <p>üõ†Ô∏è Schmiede: Item Crafting & Upgrade</p>
      <button onclick="craftItem()">Item craften (10 Gold)</button>
    `;
  }
  if(id==="arena"){
    box.innerHTML = `
      <p>‚öîÔ∏è Arena: PvP (Einfacher Kampf gegen Gegner)</p>
      <button onclick="arenaFight()">Kampf starten</button>
    `;
  }
  if(id==="shop"){
    box.innerHTML = `
      <p>üõí Markt: Kaufen & Verkaufen</p>
      <button onclick="buyPotion()">Trank kaufen (5 Gold)</button>
    `;
  }
  if(id==="alchemist"){
    box.innerHTML = `
      <p>üß™ Alchemist: Tr√§nke</p>
      <button onclick="usePotion()">Trank benutzen (stellt HP wieder her)</button>
    `;
  }
}

/* ================= FARM ================= */
function collectResources(){
  const bonus = 1 + player.skills.bauer * 0.1 + player.skills.agrar * 0.2;
  const gain = Math.floor(5 * bonus);
  player.wood += gain;
  player.stone += gain;
  player.food += gain;
  document.getElementById("farmLog").innerText = `+${gain} Holz, +${gain} Stein, +${gain} Nahrung`;
  save();
  updateUI();
}

function buildFarm(){
  if(player.farmBuilt){
    alert("Farm ist bereits gebaut.");
    return;
  }
  if(player.wood < 10 || player.stone < 10){
    alert("Nicht genug Ressourcen.");
    return;
  }
  player.wood -= 10;
  player.stone -= 10;
  player.farmBuilt = true;
  player.farmLevel = 1;
  player.farmTimer = Date.now();
  document.getElementById("farmLog").innerText = "Farm gebaut! Produktion startet.";
  save();
  updateUI();
}

function upgradeFarm(){
  if(!player.farmBuilt){
    alert("Du musst zuerst eine Farm bauen.");
    return;
  }
  if(player.wood < 20 || player.stone < 20){
    alert("Nicht genug Ressourcen.");
    return;
  }
  player.wood -= 20;
  player.stone -= 20;
  player.farmLevel++;
  document.getElementById("farmLog").innerText = "Farm upgraded! Produktion steigt.";
  save();
  updateUI();
}

/* ================= SHOP ================= */
function buyPotion(){
  if(player.gold < 5){
    alert("Nicht genug Gold.");
    return;
  }
  player.gold -= 5;
  player.inventory.push({id: Date.now().toString()+Math.random(), name:"Heiltrank", quality:"Gew√∂hnlich", atk:0, def:0, slot:"Potion", levelReq:1});
  updateUI();
  save();
}

/* ================= POTION ================= */
function usePotion(){
  const pot = player.inventory.find(x=>x.slot==="Potion");
  if(!pot){
    alert("Kein Trank im Inventar.");
    return;
  }
  player.hp = Math.min(player.hpMax, player.hp + 50);
  player.inventory = player.inventory.filter(x=>x.id!==pot.id);
  updateUI();
  save();
}

/* ================= ARENA ================= */
function arenaFight(){
  const stats = calcStats();
  const enemy = {
    lvl: player.level,
    atk: Math.floor(5 + player.level * 1.2),
    def: Math.floor(5 + player.level * 1.1),
    hp: 80 + player.level * 10
  };

  let playerHp = player.hp;
  let enemyHp = enemy.hp;

  while(playerHp > 0 && enemyHp > 0){
    const playerDmg = Math.max(1, stats.atk - enemy.def + Math.floor(Math.random()*5));
    enemyHp -= playerDmg;
    if(enemyHp <= 0) break;

    const enemyDmg = Math.max(1, enemy.atk - stats.def + Math.floor(Math.random()*5));
    playerHp -= enemyDmg;
  }

  if(playerHp > 0){
    player.hp = playerHp;
    player.gold += 10;
    document.getElementById("questLog").innerHTML = "Arena gewonnen! +10 Gold";
  } else {
    player.hp = 1;
    document.getElementById("questLog").innerHTML = "Arena verloren... Du √ºberlebst mit 1 HP";
  }
  save();
  updateUI();
}

/* ================= SKILLS ================= */
function canLearn(skill){
  if(player.skillPoints<=0) return false;
  if(player.skills[skill.id]>=skill.max) return false;
  if(!skill.req) return true;

  const key = Object.keys(skill.req)[0];
  return player.skills[key] >= skill.req[key];
}

function learnSkill(id){
  const skill = allSkills.find(s=>s.id===id);
  if(!skill || !canLearn(skill)) return;
  player.skills[id]++;
  player.skillPoints--;
  save();
  updateUI();
}

function renderSkills(){
  skillBox.innerHTML="";
  for(const tree in skillData){
    skillBox.innerHTML += `<h3>${tree}</h3>`;
    skillData[tree].forEach(s=>{
      const lvl = player.skills[s.id];
      const locked = !canLearn(s);
      skillBox.innerHTML += `
        <div class="skill ${locked && lvl<s.max ? "locked":""}">
          <b>${s.name}</b> (${lvl}/${s.max})<br>
          ${s.desc}<br>
          ${s.req ? `<small>Voraussetzung: ${Object.keys(s.req)[0]} ${Object.values(s.req)[0]}</small>` : ""}
          <button ${!canLearn(s) ? "disabled":""} onclick="learnSkill('${s.id}')">+</button>
        </div>`;
    });
  }
}

/* ================= UI ================= */
function updateUI(){
  if(!player) return;

  const s = calcStats();
  uiClass.textContent = player.class;
  uiLevel.textContent = player.level;
  uiXP.textContent = `${player.xp}/${player.xpMax}`;
  uiHP.textContent = `${player.hp}/${player.hpMax}`;
  uiGold.textContent = player.gold;
  uiChocolate.textContent = player.chocolate;
  uiAtk.textContent = s.atk;
  uiDef.textContent = s.def;
  uiRegen.textContent = 1 + s.regenBonus;

  uiWood.textContent = player.wood;
  uiStone.textContent = player.stone;
  uiFood.textContent = player.food;

  uiSkillPoints.textContent = player.skillPoints;

  uiFarmStatus.textContent = player.farmBuilt ? `Level ${player.farmLevel}` : "Nicht gebaut";

  renderSkills();
  updateInventory();
  renderEquip();
  save();
}

/* ================= SAVE PLAYER BACK ================= */
function save(){
  if(!player || !activeId) return;
  const idx = chars.findIndex(c=>c.id===activeId);
  if(idx === -1) return;
  player.lastSave = Date.now();
  chars[idx] = JSON.parse(JSON.stringify(player));
  saveAll(chars);
}

/* ================= INIT ================= */
renderCharList();
</script>
</body>
</html>
