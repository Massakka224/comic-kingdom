<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comic Kingdom ‚Äì Version 20</title>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding-top:80px}
nav{position:fixed;top:0;left:0;right:0;background:#fff;padding:10px;display:flex;gap:5px;z-index:10}
nav button{flex:1;padding:10px}
.section{display:none;padding:15px}
.section.active{display:block}
.box{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px}
.item{border:1px solid #ccc;padding:10px;margin:5px 0;border-radius:8px}
.empty{color:#777;font-style:italic}

.bar{background:#ddd;border-radius:8px;overflow:hidden;height:14px;margin-bottom:6px}
.bar span{display:block;height:100%;background:#4caf50}
.xp span{background:#2196f3}

#notifyBox{
 position:fixed;top:90px;right:10px;z-index:100;
 display:flex;flex-direction:column;gap:8px
}
.notify{
 background:#333;color:#fff;
 padding:10px 14px;border-radius:8px;
 animation:fade 3s forwards;font-size:13px
}
@keyframes fade{
 0%{opacity:0;transform:translateX(20px)}
 10%{opacity:1;transform:translateX(0)}
 90%{opacity:1}
 100%{opacity:0}
}
</style>
</head>

<body>

<div id="notifyBox"></div>

<!-- CHARACTER SELECT -->
<div id="charSelect" class="section active">
 <div class="box">
  <h2>Charaktere</h2>
  <div id="charList"></div>

  <h3>Neuer Charakter</h3>
  <input id="newName" placeholder="Name"><br><br>
  <select id="newClass">
   <option value="">Klasse w√§hlen</option>
   <option value="Krieger">Krieger</option>
   <option value="Magier">Magier</option>
   <option value="Kundschafter">Kundschafter</option>
  </select><br><br>
  <button onclick="createCharacter()">Erstellen</button>
 </div>
</div>

<nav id="nav" style="display:none">
 <button onclick="show('status')">Status</button>
 <button onclick="show('quests')">Quests</button>
 <button onclick="show('city')">Stadt</button>
 <button onclick="logout()">Logout</button>
</nav>

<!-- STATUS -->
<div id="status" class="section">
 <div class="box">
  <p><b id="uiName"></b> ‚Äì Level <b id="uiLevel"></b></p>

  <p>‚ù§Ô∏è HP: <span id="uiHPText"></span></p>
  <div class="bar"><span id="hpBar"></span></div>

  <p>‚≠ê XP: <span id="uiXPText"></span></p>
  <div class="bar xp"><span id="xpBar"></span></div>

  <p>üü° Gold: <b id="uiGold"></b></p>
  <p>üç´ Schokolade: <b id="uiChoco"></b></p>

  <button onclick="useChocolate()">üç´ benutzen (voll heilen)</button>
 </div>
</div>

<!-- QUESTS -->
<div id="quests" class="section">
 <div class="box">
  <h3>Aktive Quest</h3>
  <div id="questBox"></div><br>
  <button onclick="startQuest()">Neue Quest</button>
  <button onclick="cancelQuest()">Quest abbrechen</button>
 </div>
</div>

<!-- CITY -->
<div id="city" class="section">
 <div class="box">
  <h3>üèò Stadt</h3>

  <div class="item">
   <b>üè™ Markt</b><br>
   <button onclick="buyChocolate()">üç´ Schokolade kaufen (20 Gold)</button>
  </div>

  <div class="item">
   <b>üè• Heiler</b><br>
   <button onclick="healAtHealer()">‚ù§Ô∏è Heilen (10 Gold)</button>
  </div>
 </div>
</div>

<script>
const SAVE_KEY="ck_v20_fixed_final";
let chars=JSON.parse(localStorage.getItem(SAVE_KEY))||[];
let player=null;

const targets=["Ratten","Banditen","Monster","Ernte","Waren"];
const actions=["Besiege","Vertreibe","Sammle","Hilf bei","Erledige"];
const places=["im Wald","im Dorf","in der Mine","auf der Farm","in der Stadt"];

function rand(a){return Math.floor(Math.random()*a.length);}
function notify(t){
 const d=document.createElement("div");
 d.className="notify";
 d.textContent=t;
 notifyBox.appendChild(d);
 setTimeout(()=>d.remove(),3000);
}

function generateQuest(){
 const diffs=["leicht","normal","schwer"];
 const difficulty=diffs[rand(diffs)];
 let duration=4000,reward=1;
 if(difficulty==="leicht"){duration=3000;reward=0.8}
 if(difficulty==="schwer"){duration=7000;reward=1.5}

 return{
  name:`${actions[rand(actions)]} ${targets[rand(targets)]}`,
  desc:`${actions[rand(actions)]} ${targets[rand(targets)]} ${places[rand(places)]} (${difficulty})`,
  duration,reward,special:Math.random()<0.2
 };
}

function createCharacter(){
 const name=newName.value.trim();
 const cls=newClass.value;
 if(name.length<2||!cls)return alert("Name & Klasse w√§hlen");

 const hp={Krieger:120,Magier:90,Kundschafter:100}[cls];
 chars.push({
  id:crypto.randomUUID(),name,class:cls,
  level:1,xp:0,xpMax:100,
  hp,hpMax:hp,gold:50,chocolate:0,quest:null
 });
 save();renderList();notify("üÜï Charakter erstellt");
}

function selectChar(id){
 player=chars.find(c=>c.id===id);
 nav.style.display="flex";
 show("status");
 updateUI();
 notify(`üéÆ ${player.name} spielt`);
}

function startQuest(){
 if(player.quest)return;
 const q=generateQuest();
 player.quest={...q,end:Date.now()+q.duration};
 notify("üó∫ Quest gestartet");
 updateUI();
}

function cancelQuest(){
 if(player.quest){
  player.quest=null;
  notify("‚ùå Quest abgebrochen");
  updateUI();
 }
}

function checkQuest(){
 if(!player?.quest)return;
 if(Date.now()>=player.quest.end){
  const q=player.quest;
  player.quest=null;

  let gold=Math.floor((20+player.level*5)*q.reward);
  let xp=Math.floor((40+player.level*10)*q.reward);

  player.gold+=gold;
  gainXP(xp);

  if(q.special||Math.random()<0.15){
   player.chocolate++;
   notify("üç´ Schokolade erhalten");
  }

  notify(`‚úÖ Quest abgeschlossen (+${gold} Gold, +${xp} XP)`);
  updateUI();
 }
}

function gainXP(x){
 player.xp+=x;
 while(player.xp>=player.xpMax){
  player.xp-=player.xpMax;
  player.level++;
  player.xpMax=Math.floor(player.xpMax*1.4);
  player.hpMax+=10;
  player.hp=player.hpMax;
  notify("üéâ Level Up!");
 }
}

function useChocolate(){
 if(player.chocolate<=0)return;
 player.chocolate--;
 player.hp=player.hpMax;
 notify("‚ù§Ô∏è Voll geheilt");
 updateUI();
}

function buyChocolate(){
 if(player.gold<20)return notify("‚ùå Zu wenig Gold");
 player.gold-=20;
 player.chocolate++;
 notify("üç´ Gekauft");
 updateUI();
}

function healAtHealer(){
 if(player.gold<10)return notify("‚ùå Zu wenig Gold");
 player.gold-=10;
 player.hp=player.hpMax;
 notify("üè• Geheilt");
 updateUI();
}

function show(id){
 document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

function updateUI(){
 if(!player)return;
 uiName.textContent=player.name;
 uiLevel.textContent=player.level;
 uiGold.textContent=player.gold;
 uiChoco.textContent=player.chocolate;

 uiHPText.textContent=`${player.hp} / ${player.hpMax}`;
 uiXPText.textContent=`${player.xp} / ${player.xpMax}`;

 hpBar.style.width=(player.hp/Math.max(1,player.hpMax)*100)+"%";
 xpBar.style.width=(player.xp/Math.max(1,player.xpMax)*100)+"%";

 questBox.innerHTML=player.quest
  ? `<b>${player.quest.name}</b><br>${player.quest.desc}`
  : "<i>Keine aktive Quest</i>";

 save();
}

function logout(){
 player=null;
 nav.style.display="none";
 show("charSelect");
 renderList();
 notify("üëã Logout");
}

function save(){localStorage.setItem(SAVE_KEY,JSON.stringify(chars));}
function renderList(){
 charList.innerHTML="";
 if(!chars.length)return charList.innerHTML="<p class='empty'>Keine Charaktere</p>";
 chars.forEach(c=>{
  charList.innerHTML+=`
   <div class="item">
    <b>${c.name}</b> (${c.class})<br>
    <button onclick="selectChar('${c.id}')">Spielen</button>
    <button onclick="deleteChar('${c.id}')">L√∂schen</button>
   </div>`;
 });
}

setInterval(()=>{if(player){checkQuest();updateUI();}},1000);
renderList();
</script>
</body>
</html>
